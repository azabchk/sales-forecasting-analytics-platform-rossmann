# Архитектура системы

## 1. Общая схема

```text
        +------------------------------+
        |   Rossmann CSV (Kaggle)      |
        |   train.csv, store.csv       |
        +--------------+---------------+
                       |
                       v
        +------------------------------+
        |         ETL (Python)         |
        |    etl_load.py, DQ checks    |
        +--------------+---------------+
                       |
                       v
        +------------------------------+
        | PostgreSQL DWH (Star Schema) |
        | dim_store, dim_date, fact    |
        +-------+---------------+------+
                |               |
                v               v
     +----------------+   +----------------+
     | SQL KPI Views  |   | ML Pipeline     |
     | summary, ts,   |   | features/train/ |
     | promo impact   |   | evaluate/predict|
     +-------+--------+   +--------+-------+
             |                     |
             +----------+----------+
                        |
                        v
              +-------------------+
              | FastAPI /api/v1   |
              | KPI + Forecast    |
              +---------+---------+
                        |
                        v
              +-------------------+
              | React Dashboard   |
              | Overview/Store/FC |
              +-------------------+
```

## 2. Компоненты

### 2.1 Data Layer

- Источник данных: Kaggle Rossmann Store Sales.
- Формат: CSV.
- Хранилище сырых файлов: `data/`.

### 2.2 Data Warehouse Layer

Схема звезды (Star Schema):

- `dim_store`
  - атрибуты магазина (тип, ассортимент, конкуренция, promo2).
- `dim_date`
  - календарные атрибуты (день, месяц, квартал, неделя, выходной).
- `fact_sales_daily`
  - факт ежедневных продаж по магазину и дате.

Ключи:
- `fact_sales_daily.store_id -> dim_store.store_id`
- `fact_sales_daily.date_id -> dim_date.date_id`

### 2.3 ETL Layer

Скрипт `etl/etl_load.py`:
- читает `train.csv` и `store.csv`;
- очищает пропуски и типы;
- строит `dim_date` по покрытию дат;
- загружает таблицы в транзакции;
- использует стратегию `truncate + reload` для идемпотентности.

Скрипт `etl/data_quality.py`:
- проверка NULL в ключевых полях;
- проверка дубликатов `store_id + date_id`;
- проверка непрерывности календаря;
- проверка FK-целостности.

### 2.4 Analytics SQL Layer

Представления:
- `v_kpi_summary`
- `v_sales_timeseries_daily`
- `v_sales_timeseries_monthly`
- `v_top_stores_by_sales`
- `v_promo_impact`

Эти views являются контрактным аналитическим слоем для backend.

### 2.5 ML Layer

Модуль `ml/` реализует:
- генерацию признаков (lags, rolling, calendar, promo/holiday, metadata);
- обучение Ridge и CatBoost;
- выбор лучшей модели по RMSE;
- сохранение модели и метаданных в `ml/artifacts/`.

Инференс:
- рекурсивное предсказание на `N` дней;
- источник истории — `fact_sales_daily`.

### 2.6 Backend Layer

FastAPI сервис (`backend/app`):
- `GET /health`
- `GET /stores`
- `GET /kpi/summary`
- `GET /sales/timeseries`
- `POST /forecast`
- дополнительный: `GET /kpi/promo-impact`

Особенности:
- Pydantic-схемы;
- централизованная конфигурация через `.env`;
- CORS для frontend;
- обработка ошибок уровня API.

### 2.7 Frontend Layer

React + TypeScript (Vite):
- Overview: KPI + общая динамика;
- Store Analytics: выбор магазина + daily chart + promo impact;
- Forecast: выбор магазина + горизонт + график прогноза.

Интеграция через `VITE_API_BASE_URL`.

## 3. Поток данных

1. Пользователь загружает CSV в `data/`.
2. ETL переносит данные в DWH.
3. SQL views формируют аналитический слой.
4. ML train создает артефакты модели.
5. FastAPI отдает KPI и прогнозные данные.
6. React отображает результаты.

## 4. Нефункциональные требования

- Безопасность:
  - отсутствие hardcoded секретов;
  - конфигурация через `.env`.
- Воспроизводимость:
  - единые команды запуска;
  - изолированные `requirements.txt`.
- Расширяемость:
  - модульное разделение ETL/ML/backend/frontend.

## 5. Вычислительная среда

Целевая ОС: Ubuntu 24.04.

Технологический стек:
- PostgreSQL 16
- Python 3.11+
- FastAPI
- React + TypeScript
- Docker Compose (локальный Postgres)

## 6. Ответственность модулей

- `sql/` — схема, views, индексы.
- `etl/` — загрузка данных и DQ.
- `ml/` — обучение, оценка, прогноз.
- `backend/` — API слой.
- `frontend/` — пользовательский интерфейс.
- `docs/` — академическая и техническая документация.
